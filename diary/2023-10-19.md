&nbsp;네번째 날에는 추천(관련) 영화 목록 API를 구현했습니다.

&nbsp;themoviedb 서비스의 API 문서에서는 API의 요청과 응답 구조에 대해서 확인할 수 있을 뿐 어떤 규칙에 따라서 목록을 찾는지에 대해서는 확인하지 못 했습니다. 따라서 추천 목록을 구해오는 규칙을 직접 생각해보기로 했습니다. 엘라스틱서치의 검색 API에서는 검색 결과를 구하기 위해 score라는 필드로 점수를 매기고 높은 순서대로 가져옵니다. 이러한 방법을 활용해서 요청으로 받은 영화와의 관련성을 점수로 매겨서 높은 순서대로 가져오면 되겠다고 생각했습니다.

&nbsp;컬렉션이 일치하는 경우 +5점, 장르가 하나 일치할 때마다 +3점, 제작사가 하나 일치할 때마다 +2점을 주고 투표평점과 인기지수는 값의 분포도를 파악해서 가중치를 설정해봤습니다. 이를 SQL로 먼저 만들어봤고 QueryDSL로 옮겨보려고 했습니다. 그 과정에서 JPQL은 from/join절에 서브쿼리를 사용할 수 없고 union all이나 full outer join을 사용할 수 없음을 알게됐습니다. 결국 최후의 방법으로 네이티브 쿼리를 사용했습니다.